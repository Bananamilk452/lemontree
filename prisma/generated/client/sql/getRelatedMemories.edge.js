
/* !!! This is code generated by Prisma. Do not edit directly. !!!
/* eslint-disable */
"use strict"
const { makeTypedQueryFactory: $mkFactory } = require("../runtime/edge.js")
exports.getRelatedMemories = /*#__PURE__*/ $mkFactory("WITH\ndiary_embeddings AS (\nSELECT embedding.vector, embedding.\"diaryId\"\nFROM embedding\nWHERE \"diaryId\" = $1\n),\nmemory_embeddings AS (\nSELECT memory.id AS \"memoryId\", embedding.vector AS memory_vector, memory.content, diary.date as date\nFROM memory\nJOIN embedding ON memory.id = embedding.\"memoryId\"\nJOIN diary ON memory.\"diaryId\" = diary.id\nWHERE $2 > diary.date\n),\nall_similarities AS (\nSELECT\nd.\"diaryId\",\nm.\"memoryId\",\nm.content,\nm.date,\n1 - (d.vector <=> m.memory_vector) AS cosine_similarity\nFROM\ndiary_embeddings d\nCROSS JOIN\nmemory_embeddings m\n),\nmax_similarities AS (\nSELECT\n\"memoryId\",\nMAX(cosine_similarity) AS max_cosine_similarity\nFROM\nall_similarities\nGROUP BY\n\"memoryId\"\n)\n\nSELECT\na.\"memoryId\",\na.content,\na.cosine_similarity,\na.date\nFROM\nall_similarities a\nJOIN\nmax_similarities m ON a.\"memoryId\" = m.\"memoryId\" AND a.cosine_similarity = m.max_cosine_similarity\nWHERE a.cosine_similarity >= 0.73\nORDER BY\na.cosine_similarity DESC;")
